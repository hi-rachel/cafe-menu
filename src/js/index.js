// ìš”êµ¬ì‚¬í•­ ë¶„ì„

// ## ğŸ¯ step1 ìš”êµ¬ì‚¬í•­ - ë” ì¡°ì‘ê³¼ ì´ë²¤íŠ¸ í•¸ë“¤ë§ìœ¼ë¡œ ë©”ë‰´ ê´€ë¦¬í•˜ê¸°

// TODO ë©”ë‰´ ì¶”ê°€
// - [âœ…] ë©”ë‰´ ì´ë¦„ì„ ì…ë ¥ ë°›ê³  í™•ì¸ ë²„íŠ¼ ëˆ„ë¥´ë©´ ë©”ë‰´ê°€ ì¶”ê°€ëœë‹¤.
// - [âœ…] ë©”ë‰´ ì´ë¦„ì„ ì…ë ¥ ë°›ê³  ì—”í„°í‚¤ ì…ë ¥ìœ¼ë¡œ ì¶”ê°€í•œë‹¤.
// - [âœ…]ì¶”ê°€ë˜ëŠ” ë©”ë‰´ì˜ ì•„ë˜ ë§ˆí¬ì—…ì€ `<ul id="menu-list" class="mt-3 pl-0"></ul>` ì•ˆì— ì‚½ì…í•´ì•¼ í•œë‹¤.
// - [âœ…] ì´ ë©”ë‰´ ê°¯ìˆ˜ë¥¼ countí•˜ì—¬ ìƒë‹¨ì— ë³´ì—¬ì¤€ë‹¤.
// - [âœ…] ë©”ë‰´ê°€ ì¶”ê°€ë˜ê³  ë‚˜ë©´, inputì€ ë¹ˆ ê°’ìœ¼ë¡œ ì´ˆê¸°í™”í•œë‹¤.
// - [âœ…] ì‚¬ìš©ì ì…ë ¥ê°’ì´ ë¹ˆ ê°’ì´ë¼ë©´ ì¶”ê°€ë˜ì§€ ì•ŠëŠ”ë‹¤.

// TODO ë©”ë‰´ ìˆ˜ì •
// - [âœ…] ë©”ë‰´ì˜ ìˆ˜ì • ë²„íŠ¼ì„ ëˆŒëŸ¬ ë©”ë‰´ ì´ë¦„ ìˆ˜ì •í•  ìˆ˜ ìˆë‹¤.
// - [âœ…] ë©”ë‰´ ìˆ˜ì •ì‹œ ë¸Œë¼ìš°ì €ì—ì„œ ì œê³µí•˜ëŠ” `prompt` ì¸í„°í˜ì´ìŠ¤ë¥¼ í™œìš©í•œë‹¤.
// - [âœ…] `prompt` ì¸í„°í˜ì´ìŠ¤ì—ì„œ ë©”ë‰´ëª… ìˆ˜ì • í›„ í™•ì¸ ë²„íŠ¼ ë˜ëŠ” ì—”í„°í‚¤ ì…ë ¥ìœ¼ë¡œ ìˆ˜ì •ëœë‹¤.

// TODO ë©”ë‰´ ì‚­ì œ
// - [âœ…] ë©”ë‰´ ì‚­ì œ ë²„íŠ¼ì„ ì´ìš©í•˜ì—¬ ë©”ë‰´ ì‚­ì œí•  ìˆ˜ ìˆë‹¤.
// - [âœ…] ë©”ë‰´ ì‚­ì œì‹œ ë¸Œë¼ìš°ì €ì—ì„œ ì œê³µí•˜ëŠ” `confirm` ì¸í„°í˜ì´ìŠ¤ë¥¼ í™œìš©í•œë‹¤.
// - [âœ…] ì´ ë©”ë‰´ ê°¯ìˆ˜ë¥¼ countí•˜ì—¬ ìƒë‹¨ì— ë³´ì—¬ì¤€ë‹¤.

// ì½”ë“œ ì‘ì„± í›„ ë¦¬íŒ©í„°ë§ => ì½”ë“œ ì¤‘ë³µì„ ì¤„ì´ê³  ê°€ë…ì„±ì„ ë†’ì—¬ì¤€ë‹¤.
// ë¦¬íŒ©í„°ë§ í›„ ì½”ë“œ ì •ìƒ ì‘ë™í•˜ëŠ”ì§€ ê¼­ í™•ì¸ => í…ŒìŠ¤íŠ¸ ì½”ë“œ í™œìš©

// ğŸ¯ step2 ìš”êµ¬ì‚¬í•­ - ìƒíƒœ ê´€ë¦¬ë¡œ ë©”ë‰´ ê´€ë¦¬í•˜ê¸°

// TODO localStorage Read & Write
// - [âœ…] localStorageì— ë°ì´í„°ë¥¼ ì €ì¥í•œë‹¤.
// - [âœ…] ë©”ë‰´ë¥¼ ì¶”ê°€í•  ë•Œ ë°ì´í„°ë¥¼ ì €ì¥í•œë‹¤.
// - [âœ…] ë©”ë‰´ë¥¼ ìˆ˜ì •í•  ë•Œ ë°ì´í„°ë¥¼ ì €ì¥í•œë‹¤.
// - [âœ…] ë©”ë‰´ë¥¼ ì‚­ì œí•  ë•Œ ë°ì´í„°ë¥¼ ì €ì¥í•œë‹¤.
// - [âœ…] localStorageì— ìˆëŠ” ë°ì´í„°ë¥¼ ì½ì–´ì˜¨ë‹¤.
//(https://developer.mozilla.org/ko/docs/Web/API/Window/localStorage)

// TODO ì¹´í…Œê³ ë¦¬ë³„ ë©”ë‰´íŒ ê´€ë¦¬
// - [âœ…] ì—ìŠ¤í”„ë ˆì†Œ ë©”ë‰´íŒ ê´€ë¦¬
// - [âœ…] í”„ë¼í‘¸ì¹˜ë…¸ ë©”ë‰´íŒ ê´€ë¦¬
// - [âœ…] ë¸”ë Œë””ë“œ ë©”ë‰´íŒ ê´€ë¦¬
// - [âœ…] í‹°ë°”ë‚˜ ë©”ë‰´íŒ ê´€ë¦¬
// - [âœ…] ë””ì €íŠ¸ ë©”ë‰´íŒ ê´€ë¦¬ (ê°ê°ì˜ ì¢…ë¥˜ë³„ë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆê²Œ ë§Œë“ ë‹¤.)

// TODO í˜ì´ì§€ ì ‘ê·¼ì‹œ ìµœì´ˆ ë°ì´í„° Read & Rendering
// - [âœ…] í˜ì´ì§€ì— ìµœì´ˆ ë¡œë”©ì‹œ localStorageì˜ ì—ìŠ¤í”„ë ˆì†Œ ë©”ë‰´ë¥¼ ì½ì–´ì˜¨ë‹¤.
// - [âœ…] ì—ìŠ¤í”„ë ˆì†Œ ë©”ë‰´ë¥¼ í˜ì´ì§€ì— ë³´ì—¬ì¤€ë‹¤.

// TODO í’ˆì ˆ ê´€ë¦¬
// - [âœ…] í’ˆì ˆ ìƒíƒœì¸ ê²½ìš°ë¥¼ ë³´ì—¬ì¤„ ìˆ˜ ìˆê²Œ, í’ˆì ˆ ë²„íŠ¼ì„ ì¶”ê°€í•œë‹¤.
// - [âœ…] í’ˆì ˆ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ `sold-out` classë¥¼ ì¶”ê°€í•˜ì—¬ ìƒíƒœë¥¼ ë³€ê²½í•œë‹¤.
// - [âœ…] í’ˆì ˆ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ localStorageì— ìƒíƒœê°’ì´ ì €ì¥ëœë‹¤.
// - [âœ…] í’ˆì ˆ ìƒíƒœì—ì„œ ë²„íŠ¼ì„ ë‹¤ì‹œ í•œë²ˆ ëˆ„ë¥´ë©´ `sold-out` classê°€ ì œê±°ëœë‹¤.
// - [âœ…] í’ˆì ˆ ìƒíƒœì—ì„œ ë²„íŠ¼ì„ ë‹¤ì‹œ í•œë²ˆ ëˆ„ë¥´ë©´ localStorageì— ìƒíƒœê°’ì´ ì €ì¥ëœë‹¤.

// ğŸ™ŒğŸ¼ ì¶”ê°€í•˜ê³  ì‹¶ì€ ê¸°ëŠ¥
// - [ ] ìƒˆë¡œê³ ì¹¨ì‹œ ì›ë˜ ë³´ë˜ í˜ì´ì§€ë¥¼ ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì£¼ëŠ” ê¸°ëŠ¥
// - [ ] ì¹´í…Œê³ ë¦¬ ì¶”ê°€ / ì‚­ì œ ê¸°ëŠ¥

// ## ğŸ¯ step3 ìš”êµ¬ì‚¬í•­ - ì„œë²„ì™€ì˜ í†µì‹ ì„ í†µí•´ ë©”ë‰´ ê´€ë¦¬í•˜ê¸°

// TODO ì„œë²„ ìš”ì²­ ë¶€ë¶„
// - [âœ…] [ë§í¬](https://github.com/blackcoffee-study/moonbucks-menu-server)ì— ìˆëŠ” ì›¹ ì„œë²„ ì €ì¥ì†Œë¥¼ cloneí•˜ì—¬ ë¡œì»¬ì—ì„œ ì›¹ ì„œë²„ë¥¼ ì‹¤í–‰ì‹œí‚¨ë‹¤.
// - [âœ…] ì›¹ ì„œë²„ë¥¼ ë„ìš´ë‹¤.
// - [âœ…] ì„œë²„ì— ìƒˆë¡œìš´ ë©”ë‰´ëª…ì´ ì¶”ê°€ë  ìˆ˜ ìˆë„ë¡ ìš”ì²­í•œë‹¤.
// - [âœ…] ì„œë²„ì— ì¹´í…Œê³ ë¦¬ë³„ ë©”ë‰´ë¦¬ìŠ¤íŠ¸ë¥¼ ìš”ì²­í•œë‹¤.
// - [ ] ì„œë²„ì— ë©”ë‰´ ì´ë¦„ì´ ìˆ˜ì •ë  ìˆ˜ ìˆë„ë¡ ìš”ì²­í•œë‹¤.
// - [ ] ì„œë²„ì— ë©”ë‰´ì˜ í’ˆì ˆ ìƒíƒœë¥¼ í† ê¸€ ë  ìˆ˜ ìˆë„ë¡ ìš”ì²­í•œë‹¤.
// - [ ] ì„œë²„ì— ë©”ë‰´ê°€ ì‚­ì œ ë  ìˆ˜ ìˆë„ë¡ ìš”ì²­í•œë‹¤.

// TODO ë¦¬íŒ©í„°ë§ ë¶€ë¶„
// - [ ] localStorageì— ì €ì¥í•˜ëŠ” ë¡œì§ì€ ì§€ìš´ë‹¤.
// - [ ] fetch ë¹„ë™ê¸° apië¥¼ ì‚¬ìš©í•˜ëŠ” ë¶€ë¶„ì„ async awaitì„ ì‚¬ìš©í•˜ì—¬ êµ¬í˜„í•œë‹¤.

// TODO ì‚¬ìš©ì ê²½í—˜
// - [ ] API í†µì‹ ì´ ì‹¤íŒ¨í•˜ëŠ” ê²½ìš°ì— ëŒ€í•´ ì‚¬ìš©ìê°€ ì•Œ ìˆ˜ ìˆê²Œ[alert](https://developer.mozilla.org/ko/docs/Web/API/Window/alert)ë¡œ ì˜ˆì™¸ì²˜ë¦¬ë¥¼ ì§„í–‰í•œë‹¤.
// - [ ] ì¤‘ë³µë˜ëŠ” ë©”ë‰´ëŠ” ì¶”ê°€í•  ìˆ˜ ì—†ë‹¤.

import { $ } from "./utils/dom.js";
import store from "./store/index.js";

const BASE_URL = "http://localhost:3000/api";

const MenuApi = {
  async getAllMenuByCategory(category) {
    const response = await fetch(`${BASE_URL}/category/${category}/menu`);
    return response.json();
  },
  async createMenu(category, name) {
    const response = await fetch(`${BASE_URL}/category/${category}/menu`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ name }),
    });
    if (!response.ok) {
      console.error(response);
    }
  },
  async editMenu(category, name, menuId) {
    const response = await fetch(
      `${BASE_URL}/category/${category}/menu/${menuId}`,
      {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ name }),
      }
    );
    if (!response.ok) {
      console.error(response);
    }
    return response.json();
  },
};

function App() {
  // ìƒíƒœ(= ë³€í•˜ëŠ” ë°ì´í„°) - ë©”ë‰´ëª…
  // ì´ˆê¸°í™” + ë°ì´í„° í˜•íƒœ ì„ ì–¸(ë°°ì—´)
  this.menu = {
    espresso: [],
    frappuccino: [],
    blended: [],
    teavana: [],
    desert: [],
  };
  this.currentCategory = "espresso";

  this.init = async () => {
    this.menu[this.currentCategory] = await MenuApi.getAllMenuByCategory(
      this.currentCategory
    );
    renderMenu();
    initEventListeners();
  };

  const renderMenu = () => {
    const template = this.menu[this.currentCategory]
      .map((item, index) => {
        return `<li data-menu-id="${
          item.id
        }" class="menu-list-item d-flex items-center py-2">
        <span class="w-100 pl-2 menu-name ${item.soldOut ? "sold-out" : ""}">${
          item.name
        }</span>
          <button
    type="button"
    class="bg-gray-50 text-gray-500 text-sm mr-1 menu-sold-out-button"
  >
    í’ˆì ˆ
  </button>
        <button
            type="button"
            class="bg-gray-50 text-gray-500 text-sm mr-1 menu-edit-button"
        >
            ìˆ˜ì •
        </button>
        <button
            type="button"
            class="bg-gray-50 text-gray-500 text-sm menu-remove-button"
        >
            ì‚­ì œ
        </button>
        </li>`;
      })
      .join("");

    $("#menu-list").innerHTML = template;
    updateMenuCount();
  };

  const updateMenuCount = () => {
    const menuCount = this.menu[this.currentCategory].length;
    $(".menu-count").innerText = `ì´ ${menuCount}ê°œ`;
  };

  const addMenuName = async () => {
    if ($("#menu-name").value === "") {
      alert("ë©”ë‰´ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }
    const menuName = $("#menu-name").value;
    await MenuApi.createMenu(this.currentCategory, menuName);
    this.menu[this.currentCategory] = await MenuApi.getAllMenuByCategory(
      this.currentCategory
    );
    renderMenu();
    $("#menu-name").value = "";
  };

  const editMenuName = async (e) => {
    const menuId = e.target.closest("li").dataset.menuId;
    const $menuName = e.target.closest("li").querySelector(".menu-name");
    const editedMenuName = prompt(
      "ìˆ˜ì •í•˜ê³  ì‹¶ì€ ë©”ë‰´ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.",
      $menuName.innerText
    );
    await MenuApi.editMenu(this.currentCategory, editedMenuName, menuId);
    this.menu[this.currentCategory] = await MenuApi.getAllMenuByCategory(
      this.currentCategory
    );
    renderMenu();
  };

  const removeMenu = (e) => {
    if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      const menuId = e.target.closest("li").dataset.menuId;
      this.menu[this.currentCategory].splice(menuId, 1);
      store.setLocalStrage(this.menu);
      renderMenu();
    }
  };

  const soldOutMenu = (e) => {
    const menuId = e.target.closest("li").dataset.menuId;
    this.menu[this.currentCategory][menuId].soldOut =
      !this.menu[this.currentCategory][menuId].soldOut;
    store.setLocalStrage(this.menu);
    renderMenu();
  };

  const initEventListeners = () => {
    // event ìœ„ì„
    $("#menu-list").addEventListener("click", (e) => {
      if (e.target.classList.contains("menu-edit-button")) {
        editMenuName(e);
        // ë’· ë¶€ë¶„ê³¼ ê´€ë ¨ì—†ì´ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜ê°€ ì—°ì†ìœ¼ë¡œ ìˆì„ ë•Œ returnì„ í•´ì£¼ì–´ ë¶ˆí•„ìš”í•œ ì—°ì‚°ì„ ì¤„ì—¬ì¤Œ.
        return;
      }

      if (e.target.classList.contains("menu-remove-button")) {
        removeMenu(e);
        return;
      }

      if (e.target.classList.contains("menu-sold-out-button")) {
        soldOutMenu(e);
        return;
      }
    });

    $("#menu-form").addEventListener("submit", (e) => {
      e.preventDefault();
    });

    $("#menu-submit-button").addEventListener("click", addMenuName);

    // 'Enter'í‚¤ê°€ ì•„ë‹Œ ë‹¤ë¥¸ í‚¤ë¥¼ ëˆŒë €ì„ ë•Œ alert ëœ¨ëŠ” ê²ƒ ë°©ì§€
    $("#menu-name").addEventListener("keypress", (e) => {
      if (e.key !== "Enter") {
        return;
      }
      addMenuName();
    });

    $("nav").addEventListener("click", async (e) => {
      const isCategoryBtn = e.target.classList.contains("cafe-category-name");
      if (isCategoryBtn) {
        const categoryName = e.target.dataset.categoryName;
        this.currentCategory = categoryName;
        $("#category-title").innerText = `${e.target.innerText} ë©”ë‰´ ê´€ë¦¬`;
        this.menu[this.currentCategory] = await MenuApi.getAllMenuByCategory(
          this.currentCategory
        );
        renderMenu();
      }
    });
  };
}

const app = new App();
app.init();
// new í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒì„±ì í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê²Œ ë˜ë©´ ì´ë•Œì˜ thisëŠ” "ë§Œë“¤ì–´ì§ˆ ê°ì²´"ë¥¼ ì°¸ì¡°í•œë‹¤.
